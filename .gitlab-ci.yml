variables:
  DOCKER_TLS_CERTDIR: ''

image: node:12

cache: &global_cache
  paths:
    - node_modules/
  policy: pull-push

.install_packages: &install_packages
  - |
    if [[ ! -d "node_modules" ]]; then
        yarn install --network-timeout 1000000
    fi

stages:
  - build:image
  - setup
  - deploy

.swpc-runner:
  tags:
    - aws
    - m4-large

default:
  tags:
    - TPEA90099186

build:image:
  stage: build:image
  image: docker:19.03.8
  services:
    - docker:19.03.8-dind
  only:
    refs:
      - master
    changes:
      - src/**/*
      - Dockerfile
      - package.json
      - .gitlab-ci.yml
      - .env.*
  script:
    - docker pull harbor.wistron.com/k8sprdwhqecossot2021/eco-ssot-frontend || true
    - docker build -t harbor.wistron.com/k8sprdwhqecossot2021/eco-ssot-frontend .
    - docker push harbor.wistron.com/k8sprdwhqecossot2021/eco-ssot-frontend
  cache: {}
  dependencies: []

setup:
  stage: setup
  only:
    refs:
      - master
    changes:
      - package.json
      - yarn.lock
  script:
    - yarn install --network-timeout 1000000
  dependencies: []

deploy:
  stage: deploy
  only:
    - master
  before_script:
    - *install_packages
    - git config --global user.email leo_jhuo@wistron.com
    - git config --global user.name eco-ssot-frontend-ci
    - git remote add github https://$GITHUB_API_KEY@github.com/eco-ssot/eco-ssot.github.io.git
  script:
    - yarn deploy
  when: on_success
  dependencies: []
