image: $CI_REGISTRY_IMAGE

variables:
  DOCKER_TLS_CERTDIR: ''
  GIT_SSL_NO_VERIFY: "true"

stages:
  - deploy
  - update-image

.swpc-runner:
  tags:
    - aws
    - m4-large

default:
  tags:
    - TPEA90099186

.deploy:
  stage: deploy
  services:
    - docker:19.03.8-dind
  only:
    refs:
      - tags
      - dev
      - master
  variables:
    USER: $SSOT_USER_NAME
    TOKEN: $SSOT_USER_TOKEN
    STAGE: prod
    TAG: $CI_COMMIT_TAG
  before_script:
    - echo "$TOKEN" | docker login -u $USER --password-stdin harbor.wistron.com
  script:
    - docker build --build-arg STAGE=$STAGE -t harbor.wistron.com/k8sprdwhqecossot2021/eco-ssot-frontend:$TAG .
    - docker push harbor.wistron.com/k8sprdwhqecossot2021/eco-ssot-frontend:$TAG
  cache: {}
  dependencies: []

deploy:dev:
  only:
    refs:
      - dev
  variables:
    STAGE: dev
    TAG: $CI_COMMIT_BRANCH
  script:
    - export VERSION=$(cat package.json | jq -r .version)
    - export IMAGE=harbor.wistron.com/k8sprdwhqecossot2021/eco-ssot-frontend:$VERSION-$TAG
    - docker build --build-arg STAGE=$STAGE -t $IMAGE .
    - docker push $IMAGE
    - |
      curl \
      -X PUT \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer $RANCHER_TOKEN" \
      -d "{\"image\": \"$IMAGE\"}" \
      "https://k8sprd-whq.wistron.com/v3/project/local:p-w666x/workloads/deployment:eco-ssot-2021-dev:eco-ssot-2021-frontend"
  extends: .deploy

deploy:prod:
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /prod|prd/
  extends: .deploy
